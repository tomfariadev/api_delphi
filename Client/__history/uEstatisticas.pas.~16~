unit uEstatisticas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, System.JSON, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.Buttons;

type
  TFEstatisticas = class(TForm)
    PTop: TPanel;
    BRefresh: TBitBtn;
    PTotal: TPanel;
    PMedia: TPanel;
    LblMedia: TLabel;
    LblTotal: TLabel;
    PConcluidos: TPanel;
    LblConcluidos: TLabel;
    procedure FormShow(Sender: TObject);
  private
    procedure MostarEstatisticas;
  public
    { Public declarations }
  end;

var
  FEstatisticas: TFEstatisticas;

implementation

{$R *.dfm}

uses uDM;

{ TFEstatisticas }

procedure TFEstatisticas.FormShow(Sender: TObject);
begin
  MostarEstatisticas;
end;

procedure TFEstatisticas.MostarEstatisticas;
var
  Json: TJSONObject;
begin
  try
    DM.ReqTarefaStats.Params.Clear;
    DM.ReqTarefaStats.Execute;

    if DM.ReqTarefaStats.Response.StatusCode = 200 then
    begin
      Json := DM.ReqTarefaStats.Response.JSONValue as TJSONObject;

      LblTotal.Caption := 'Total de tarefas: ' +
                           Json.GetValue<Integer>('TotalTarefas').ToString;

      LblMedia.Caption := 'Média com Prioridade = (P) Pendente: ' +
                           FormatFloat('0.00', Json.GetValue<Double>('MediaPrioridadePendentes'));

      LblConcluidos.Caption:= 'Tarefas concluídas nos últimos 7 dias: ' +
                               Json.GetValue<Integer>('ConcluidaUltimos7Dias').ToString;
    end
    else
      ShowMessage('Erro ao obter estatísticas: ' + DM.ReqTarefaStats.Response.Content);
  except
    on E: Exception do
      ShowMessage('Erro na requisição: ' + E.Message);
  end;
end;

end.
